<div id="silly-sim-tracker-settings">
  <div class="inline-drawer">
    <div class="inline-drawer-toggle inline-drawer-header">
      <b>Silly Sim Tracker</b>
      <div
        class="inline-drawer-icon fa-solid fa-circle-chevron-down down"
      ></div>
    </div>
    <div class="inline-drawer-content">
      <div class="silly-sim-tracker-settings-content">
        <div class="setting">
          <label for="isEnabled">Enable Tracker</label>
          <div class="control"><input type="checkbox" id="isEnabled" /></div>
        </div>
        <p class="description">
          The master switch to enable or disable the extension.
        </p>
        <hr />
        <div class="setting">
          <label for="codeBlockIdentifier">Code Block Identifier</label>
          <div class="control">
            <input type="text" id="codeBlockIdentifier" class="text_pole" />
          </div>
        </div>
        <p class="description">
          The keyword the extension looks for after the opening ``` (e.g.,
          "sim").
        </p>
        <hr />
        <div class="setting">
          <label for="defaultBgColor">Default Card Color</label>
          <div class="control"><input type="color" id="defaultBgColor" /></div>
        </div>
        <p class="description">
          The background color used for cards when one isn't specified in the
          JSON.
        </p>
        <hr />
        <div class="setting">
          <label for="showThoughtBubble">Show Thought Bubble</label>
          <div class="control">
            <input type="checkbox" id="showThoughtBubble" />
          </div>
        </div>
        <p class="description">
          Whether to display the 'thought' section at the bottom of the card.
        </p>
        <hr />

        <div class="setting">
          <label for="templateFile">Default Template</label>
          <select id="templateFile" class="text_pole"></select>
        </div>
        <div class="description">
          Select a built-in template. This is used when no custom template is
          loaded.
        </div>

        <div class="setting">
          <label for="templatePosition">Template Position</label>
          <select id="templatePosition" class="text_pole">
            <option value="BOTTOM">Bottom (Below message)</option>
            <option value="ABOVE">Above Message</option>
            <option value="LEFT">Left Sidebar</option>
            <option value="RIGHT">Right Sidebar</option>
            <option value="MACRO">Macro Replacement</option>
          </select>
        </div>
        <div class="description">
          Select where the tracker card should be positioned relative to the message.
          Templates can override this setting with a POSITION comment.
        </div>

        <div class="setting">
          <label>Custom Template</label>
          <div class="flex-container">
            <button
              id="uploadCustomTemplateBtn"
              class="menu_button"
              title="Load a .html file from your computer to use as a custom template."
            >
              Load from File
            </button>
            <button
              id="clearCustomTemplateBtn"
              class="menu_button"
              title="Clear the loaded custom template and revert to using the selected default template."
            >
              Clear Custom
            </button>
          </div>
        </div>
        <!-- This hidden input is used to open the file dialog -->
        <input type="file" id="customTemplateUpload" hidden accept=".html" />

        <p class="description">
          Path to the HTML template file relative to tracker-card-templates/
          directory. Default: default-card-template.html
        </p>
        <hr />
        
        <!-- Custom Fields Section -->
        <h4>Custom Sim Data Fields</h4>
        <div class="setting">
            <label>Define the data fields for your sim tracker.</label>
            <button id="manageCustomFieldsBtn" class="menu_button" style="margin-top: 5px;">Manage Fields</button>
        </div>
        <p class="description">
          These fields define the structure of your sim data and are used by the <code>{{sim_format}}</code> macro in prompts.
        </p>
        <hr />
        
        <div class="setting">
          <label for="hideSimBlocks">Hide Sim Blocks in Chat</label>
          <div class="control"><input type="checkbox" id="hideSimBlocks" /></div>
        </div>
        <p class="description">
          If enabled, the raw sim JSON code blocks will be hidden from the chat display, but the tracker cards will still be generated.
        </p>
        <hr />

        <div class="setting">
          <label for="datingSimPrompt">Sim Tracker System Prompt</label>
          <textarea id="datingSimPrompt" class="text_pole" rows="6"></textarea>
        </div>
        <p class="description">
          The base prompt to be injected when you use the {{sim_tracker}} macro.
        </p>
        
        <hr />
        
        <div class="setting">
          <label>JSON Format Migration</label>
          <div class="flex-container">
            <button id="migrateJsonFormatBtn" class="menu_button" title="Migrate all existing sim data to the new format with worldData and characters array.">
              Migrate to New Format
            </button>
          </div>
        </div>
        <p class="description">
          Migrate all existing sim data to the new improved format with explicit worldData and characters array structure.
        </p>
        
        <hr />
        
        <div class="setting">
          <label>Template Preset Import/Export</label>
          <div class="flex-container">
            <button id="exportPresetBtn" class="menu_button" title="Export current template and settings as a preset file.">
              Export Preset
            </button>
            <button id="importPresetBtn" class="menu_button" title="Import a template preset from a file.">
              Import Preset
            </button>
            <button id="managePresetsBtn" class="menu_button" title="Manage your saved presets.">
              Manage Presets
            </button>
          </div>
        </div>
        <p class="description">
          Export your current template setup or import a preset from another user.
        </p>
        <!-- Hidden input for file import -->
        <input type="file" id="presetImportInput" hidden accept=".json" />
        
        <hr />
        
        <div class="setting">
          <label>Reset All Settings</label>
          <div class="flex-container">
            <button id="resetDefaultsBtn" class="menu_button" style="background-color: #c0392b; color: white;" title="Reset all settings to their default values.">
              Reset Defaults
            </button>
          </div>
        </div>
        <p class="description">
          This will reset all extension settings to their default values. This action cannot be undone.
        </p>
      </div>
    </div>
  </div>
  
  <!-- Export Preset Modal -->
  <dialog id="sst-export-preset-modal" class="popup wide_dialogue_popup large_dialogue_popup vertical_scrolling_dialogue_popup popup--animation-fast">
    <div class="popup-header">
      <h3 style="margin: 0; padding: 10px 0;">Export Template Preset</h3>
    </div>
    <div class="popup-content" style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
      <div style="margin-bottom: 15px;">
        <label for="exportTemplateName">Template Name:</label>
        <input type="text" id="exportTemplateName" class="text_pole" style="width: 100%;" />
      </div>
      <div style="margin-bottom: 15px;">
        <label for="exportTemplateAuthor">Author:</label>
        <input type="text" id="exportTemplateAuthor" class="text_pole" style="width: 100%;" />
      </div>
      <div style="margin-bottom: 15px;">
        <label for="exportTemplatePosition">Position:</label>
        <select id="exportTemplatePosition" class="text_pole" style="width: 100%;">
          <option value="BOTTOM">Bottom (Below message)</option>
          <option value="ABOVE">Above Message</option>
          <option value="LEFT">Left Sidebar</option>
          <option value="RIGHT">Right Sidebar</option>
          <option value="MACRO">Macro Replacement</option>
        </select>
      </div>
      <div style="margin-bottom: 15px;">
        <label>
          <input type="checkbox" id="exportIncludeSysPrompt" checked /> Include System Prompt
        </label>
      </div>
      <div style="margin-bottom: 15px;">
        <label>
          <input type="checkbox" id="exportIncludeCustomFields" checked /> Include Custom Fields
        </label>
      </div>
      <div style="margin-bottom: 15px;">
        <label>
          <input type="checkbox" id="exportIncludeSettings" checked /> Include Extension Settings
        </label>
      </div>
    </div>
    <div class="popup-footer" style="display: flex; justify-content: center; padding: 15px; gap: 10px;">
      <button id="sst-export-preset-confirm" class="menu_button">Export</button>
      <button id="sst-export-preset-cancel" class="menu_button">Cancel</button>
    </div>
  </dialog>
  
  <!-- Manage Presets Modal -->
  <dialog id="sst-manage-presets-modal" class="popup wide_dialogue_popup large_dialogue_popup vertical_scrolling_dialogue_popup popup--animation-fast">
    <div class="popup-header">
      <h3 style="margin: 0; padding: 10px 0;">Manage Presets</h3>
    </div>
    <div class="popup-content" style="padding: 15px; flex: 1; display: flex; flex-direction: column;">
      <div id="userPresetsList" style="flex: 1; overflow-y: auto;">
        <!-- User presets will be populated here -->
      </div>
    </div>
    <div class="popup-footer" style="display: flex; justify-content: center; padding: 15px;">
      <button id="sst-manage-presets-close" class="menu_button">Close</button>
    </div>
  </dialog>
</div>